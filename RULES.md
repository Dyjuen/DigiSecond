# DigiSecond - Project Rules

## 1. Test-Driven Development (TDD) Policy

> **RULE**: Before writing any implementation code, check if tests exist. If no tests exist for the feature/function, **write tests FIRST**.

### TDD Cycle

1. **ðŸ”´ RED**: Write a failing test that defines expected behavior
2. **ðŸŸ¢ GREEN**: Write minimal code to make the test pass
3. **ðŸ”µ REFACTOR**: Improve code while keeping tests green

### Test Framework

| Platform | Framework | Runner |
|----------|-----------|--------|
| Backend (tRPC/Prisma) | Vitest | `pnpm test src/server` |
| Web Components | Vitest + Testing Library | `pnpm test src/components` |
| Mobile | Jest + Testing Library RN | `cd mobile && pnpm test` |
| E2E | Playwright | `pnpm test:e2e` |

### When to Write Tests First

| Scenario | Action |
|----------|--------|
| New tRPC procedure | Write test â†’ implement procedure |
| New utility function | Write test â†’ implement function |
| Bug fix | Write failing test that reproduces bug â†’ fix â†’ test passes |
| New component with logic | Write test â†’ implement component |

### Test File Locations

```
src/server/api/routers/__tests__/   # Backend procedure tests
src/lib/__tests__/                   # Utility function tests
src/components/**/__tests__/         # Component tests
mobile/src/**/__tests__/             # Mobile tests
e2e/                                 # Playwright E2E tests
```

### Minimum Coverage Targets

| Module | Target |
|--------|--------|
| Business logic (fees, status transitions) | 100% |
| Validation schemas | 100% |
| tRPC procedures | 80% |
| UI components with logic | 70% |

---

## 2. Spec-First Development

> **RULE**: Check `docs/spec.md` before implementing any feature. If the feature isn't documented, add it to spec.md first.

---

## 3. Role-Based Branch Strategy

> **RULE**: We use role-based branches, NOT feature branches. Each team member works on their designated branch.

### Branch Structure

```
main                 â† Production-ready code (protected)
â”œâ”€â”€ backend          â† Backend developer's branch
â”œâ”€â”€ frontend-web     â† Frontend Web developer's branch  
â””â”€â”€ mobile           â† Frontend Mobile developer's branch
```

### Branch Ownership

| Branch | Owner | Scope |
|--------|-------|-------|
| `main` | Team Lead | Merged from role branches via PR |
| `backend` | Backend Dev | `src/server/**`, `prisma/**`, `src/lib/schemas.ts` |
| `frontend-web` | Web Dev | `src/app/**`, `src/components/**`, `src/styles/**` |
| `mobile` | Mobile Dev | `mobile/src/**` |

### Workflow

1. Always work on your role branch
2. Pull latest before starting work: `git pull origin [branch]`
3. Commit frequently with conventional commits
4. Create PR to `main` when feature is complete
5. Another team member reviews before merge

### Shared Files

For files used by multiple roles (e.g., `src/lib/schemas.ts`), coordinate via team chat before editing.

---

## 4. Shared Design Tokens

> **RULE**: All frontends (web and mobile) must use the shared color palette and design tokens defined below.

See: `.agent/skills/shared-design-tokens/SKILL.md`

---

## 4. Code Review Before Commit

> **RULE**: Always run `git diff` before committing. Review for:
> - Debug code (`console.log`, `debugger`)
> - Commented-out code
> - Hardcoded secrets
> - Scope creep (changes outside intended feature)

See: `.agent/workflows/commit.md`

---

## 5. API Contract Stability

> **RULE**: Changing tRPC procedure signatures requires:
> 1. Update `docs/spec.md`
> 2. Notify frontend devs in team chat
> 3. Consider backwards compatibility

---

## 6. Boundaries - NEVER TOUCH

> **CRITICAL**: The following files/folders should NEVER be modified or committed without explicit approval.

### Files to Never Commit

| Pattern | Reason |
|---------|--------|
| `.env`, `.env.*` | Contains secrets (API keys, DB URLs) |
| `*.pem`, `*.key` | Private keys and certificates |
| `XENDIT_*`, `SUPABASE_SERVICE_*` | Production credentials |

### Folders to Never Modify Directly

| Folder | Reason | Safe Alternative |
|--------|--------|------------------|
| `node_modules/` | Managed by package manager | Edit `package.json`, run `pnpm install` |
| `.next/` | Build output | Run `pnpm build` |
| `prisma/migrations/` | Generated by Prisma | Use `pnpm prisma migrate dev` |
| `.expo/` | Expo cache | Run `npx expo start --clear` |

### Production-Only Files

| File | Rule |
|------|------|
| `vercel.json` | Requires team lead approval |
| `eas.json` | Requires team lead approval |
| `next.config.js` rewrites/redirects | Requires review for security |

### Environment Variable Rules

```bash
# NEVER hardcode these - always use env vars
DATABASE_URL=...          # Via .env.local (gitignored)
XENDIT_SECRET_KEY=...     # Via .env.local (gitignored)
NEXTAUTH_SECRET=...       # Via .env.local (gitignored)
```

### .gitignore Requirements

These patterns MUST remain in `.gitignore`:

```
.env
.env.*
*.pem
*.key
node_modules/
.next/
.expo/
```
